/*
 * ARCHIVO DE RESPALDO - UpdateChecker.java
 * 
 * Fecha de respaldo: 13 de agosto de 2025
 * Versión del proyecto: 1.0.9-v13
 * Commit: 7cea953 (feat: Actualizar a versión 1.0.9-v13 con método multiplicarPorCinco)
 * Tag: v1.0.9
 * 
 * Propósito del respaldo: Se solicitará cambios en UpdateChecker.java para corregir un error.
 * Este archivo contiene la versión estable antes de las modificaciones.
 * 
 * Estado: FUNCIONAL - Sistema de actualizaciones operativo
 * 
 * Características principales:
 * - Verificación automática de actualizaciones desde GitHub API
 * - Sistema de elevación de privilegios corregido (sin bucle infinito)
 * - Descarga e instalación automática de updates
 * - Manejo de archivos temporales
 * - Interfaz de usuario con progress dialogs
 * - Validación de archivos descargados
 * - Scripts de instalación automatizados
 * 
 * Versión actual configurada: 1.0.9-v13
 * GitHub API: https://api.github.com/repos/abrahan-romo/installer-app/releases/latest
 * 
 * ========================================================================
 */

package org.example.updater;

import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.security.MessageDigest;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

/**
 * Sistema de actualizaciones automáticas para InstallerApp
 * Integrado con GitHub Releases API
 * 
 * @author InstallerApp Team
 * @version 1.0.0
 * @since 2025-08-03
 */
public class UpdateChecker {
    
    // Configuración del sistema de updates
    private static final String GITHUB_API_URL = "https://api.github.com/repos/abrahan-romo/installer-app/releases/latest";
    private static final String USER_AGENT = "InstallerApp-Updater/1.0";
    private static final String CURRENT_VERSION = "1.0.9-v13"; // Updated to match current version
    private static final int CONNECTION_TIMEOUT_MS = 10000;
    private static final int READ_TIMEOUT_MS = 30000;
    private static final long CHECK_INTERVAL_HOURS = 24;
    
    // Directorios del sistema
    private static final String TEMP_UPDATE_DIR = System.getProperty("java.io.tmpdir") + File.separator + "installerapp-updates" + File.separator;
    private static final String APP_DIR = System.getProperty("user.dir");
    
    // Estado del sistema
    private ScheduledExecutorService scheduler;
    private boolean updateCheckEnabled = true;
    private JFrame parentFrame;
    
    /**
     * Constructor del UpdateChecker
     * @param parentFrame Frame principal de la aplicación para mostrar dialogs
     */
    public UpdateChecker(JFrame parentFrame) {
        this.parentFrame = parentFrame;
        this.scheduler = Executors.newScheduledThreadPool(1);
        
        // Crear directorio temporal si no existe
        createTempDirectory();
    }
    
    /**
     * Inicializar el sistema de actualizaciones
     * Verificar al inicio + programar verificaciones periódicas
     */
    public void initializeUpdateSystem() {
        System.out.println("[UpdateChecker] Inicializando sistema de actualizaciones...");
        
        // Verificación al inicio (asíncrona)
        checkForUpdatesAsync("Verificación al inicio de aplicación");
        
        // Programar verificaciones periódicas
        scheduler.scheduleAtFixedRate(
            () -> checkForUpdatesAsync("Verificación programada"), 
            CHECK_INTERVAL_HOURS, 
            CHECK_INTERVAL_HOURS, 
            TimeUnit.HOURS
        );
        
        System.out.println("[UpdateChecker] Sistema inicializado. Próxima verificación en " + CHECK_INTERVAL_HOURS + " horas.");
    }
    
    /**
     * Verificar actualizaciones de forma asíncrona
     */
    public void checkForUpdatesAsync(String reason) {
        if (!updateCheckEnabled) {
            System.out.println("[UpdateChecker] Verificación deshabilitada. Saltando check.");
            return;
        }
        
        CompletableFuture.runAsync(() -> {
            try {
                System.out.println("[UpdateChecker] Verificando actualizaciones... Motivo: " + reason);
                checkForUpdates();
            } catch (Exception e) {
                System.err.println("[UpdateChecker] Error durante verificación: " + e.getMessage());
                e.printStackTrace();
            }
        });
    }
    
    /**
     * Verificación principal de actualizaciones
     */
    private void checkForUpdates() throws Exception {
        // 1. Conectar a GitHub API
        UpdateInfo updateInfo = fetchLatestReleaseInfo();
        
        if (updateInfo == null) {
            System.out.println("[UpdateChecker] No se pudo obtener información de releases.");
            return;
        }
        
        // 2. Comparar versiones
        if (isNewerVersion(updateInfo.version, CURRENT_VERSION)) {
            System.out.println("[UpdateChecker] Nueva versión disponible: " + updateInfo.version);
            
            // 3. Mostrar notificación al usuario
            SwingUtilities.invokeLater(() -> showUpdateNotification(updateInfo));
        } else {
            System.out.println("[UpdateChecker] Aplicación actualizada. Versión actual: " + CURRENT_VERSION);
        }
    }
    
    /**
     * Obtener información del último release desde GitHub API
     */
    private UpdateInfo fetchLatestReleaseInfo() {
        try {
            System.out.println("[UpdateChecker] Conectando a: " + GITHUB_API_URL);
            URL url = new URL(GITHUB_API_URL);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            
            // Configurar connection
            connection.setRequestMethod("GET");
            connection.setRequestProperty("Accept", "application/vnd.github.v3+json");
            connection.setRequestProperty("User-Agent", USER_AGENT);
            connection.setConnectTimeout(CONNECTION_TIMEOUT_MS);
            connection.setReadTimeout(READ_TIMEOUT_MS);
            
            System.out.println("[UpdateChecker] Headers enviados:");
            System.out.println("  User-Agent: " + USER_AGENT);
            System.out.println("  Accept: application/vnd.github.v3+json");
            
            int responseCode = connection.getResponseCode();
            System.out.println("[UpdateChecker] Response Code: " + responseCode);
            
            if (responseCode != 200) {
                System.err.println("[UpdateChecker] Error HTTP: " + responseCode);
                System.err.println("[UpdateChecker] Response Message: " + connection.getResponseMessage());
                
                // Leer el error response si existe
                try (InputStream errorStream = connection.getErrorStream()) {
                    if (errorStream != null) {
                        String errorResponse = readInputStream(errorStream);
                        System.err.println("[UpdateChecker] Error Response: " + errorResponse);
                    }
                } catch (Exception e) {
                    System.err.println("[UpdateChecker] No se pudo leer error response: " + e.getMessage());
                }
                return null;
            }
            
            // Leer response JSON
            String jsonResponse = readInputStream(connection.getInputStream());
            System.out.println("[UpdateChecker] Response recibido (primeros 500 chars): " + jsonResponse.substring(0, Math.min(500, jsonResponse.length())) + "...");
            
            // DEBUG: Mostrar información clave del JSON
            if (jsonResponse.contains("\"assets\"")) {
                System.out.println("[UpdateChecker] El release contiene sección 'assets'");
            } else {
                System.out.println("[UpdateChecker] ¡PROBLEMA! El release NO contiene sección 'assets'");
            }
            
            // Parsear JSON básico (implementación simple)
            return parseReleaseJson(jsonResponse);
            
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error obteniendo release info: " + e.getMessage());
            return null;
        }
    }
    
    /**
     * Parser simple de JSON para GitHub releases
     * Extrae tag_name y download URL del primer asset
     */
    private UpdateInfo parseReleaseJson(String json) {
        try {
            UpdateInfo info = new UpdateInfo();
            
            // Extraer tag_name (versión)
            String tagNamePattern = "\"tag_name\":\\s*\"([^\"]+)\"";
            java.util.regex.Pattern pattern = java.util.regex.Pattern.compile(tagNamePattern);
            java.util.regex.Matcher matcher = pattern.matcher(json);
            if (matcher.find()) {
                info.version = matcher.group(1);
            }
            
            // Extraer release notes (body)
            String bodyPattern = "\"body\":\\s*\"([^\"]+)\"";
            pattern = java.util.regex.Pattern.compile(bodyPattern);
            matcher = pattern.matcher(json);
            if (matcher.find()) {
                info.releaseNotes = matcher.group(1).replace("\\n", "\n").replace("\\r", "");
            }
            
            // Extraer download URL del primer asset .jar
            String downloadPattern = "\"browser_download_url\":\\s*\"([^\"]+\\.jar)\"";
            pattern = java.util.regex.Pattern.compile(downloadPattern);
            matcher = pattern.matcher(json);
            if (matcher.find()) {
                info.downloadUrl = matcher.group(1);
            }
            
            // DEBUG: Mostrar todos los assets encontrados
            String allAssetsPattern = "\"browser_download_url\":\\s*\"([^\"]+)\"";
            pattern = java.util.regex.Pattern.compile(allAssetsPattern);
            matcher = pattern.matcher(json);
            System.out.println("[UpdateChecker] Assets encontrados en el release:");
            int assetCount = 0;
            while (matcher.find()) {
                assetCount++;
                String assetUrl = matcher.group(1);
                System.out.println("  Asset " + assetCount + ": " + assetUrl);
            }
            if (assetCount == 0) {
                System.out.println("  ¡No se encontraron assets en el release!");
            }
            
            // Extraer nombre del archivo
            if (info.downloadUrl != null) {
                info.fileName = info.downloadUrl.substring(info.downloadUrl.lastIndexOf("/") + 1);
            }
            
            System.out.println("[UpdateChecker] Parsed: version=" + info.version + ", downloadUrl=" + info.downloadUrl);
            return info;
            
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error parseando JSON: " + e.getMessage());
            return null;
        }
    }
    
    /**
     * Comparar si newVersion es mayor que currentVersion
     * Implementación mejorada que maneja formato x.y.z-vN
     */
    private boolean isNewerVersion(String newVersion, String currentVersion) {
        if (newVersion == null || currentVersion == null) return false;
        
        // Remover prefijo 'v' si existe
        newVersion = newVersion.startsWith("v") ? newVersion.substring(1) : newVersion;
        currentVersion = currentVersion.startsWith("v") ? currentVersion.substring(1) : currentVersion;
        
        // Separar versión base y sufijo
        String[] newParts = newVersion.split("-");
        String[] currentParts = currentVersion.split("-");
        
        // Comparar versión base (x.y.z)
        String[] newNums = newParts[0].split("\\.");
        String[] currentNums = currentParts[0].split("\\.");
        
        int maxLength = Math.max(newNums.length, currentNums.length);
        
        for (int i = 0; i < maxLength; i++) {
            int newNum = i < newNums.length ? Integer.parseInt(newNums[i]) : 0;
            int currentNum = i < currentNums.length ? Integer.parseInt(currentNums[i]) : 0;
            
            if (newNum > currentNum) return true;
            if (newNum < currentNum) return false;
        }
        
        // Si las versiones base son iguales, comparar sufijos si existen
        if (newParts.length > 1 && currentParts.length > 1) {
            // Extraer números de sufijos (v7 -> 7)
            int newSuffix = Integer.parseInt(newParts[1].substring(1));
            int currentSuffix = Integer.parseInt(currentParts[1].substring(1));
            return newSuffix > currentSuffix;
        }
        
        // Si una tiene sufijo y la otra no, la que tiene sufijo es más nueva
        return newParts.length > currentParts.length;
    }
    /**
     * Mostrar notificación de actualización disponible
     */
    private void showUpdateNotification(UpdateInfo updateInfo) {
        String message = String.format(
            "Nueva versión %s disponible.\n\n" +
            "Versión actual: %s\n" +
            "Nueva versión: %s\n\n" +
            "Mejoras:\n%s\n\n" +
            "¿Desea descargar e instalar la actualización?",
            updateInfo.version,
            CURRENT_VERSION,
            updateInfo.version,
            updateInfo.releaseNotes != null ? updateInfo.releaseNotes : "Ver notas de la versión en GitHub"
        );
        
        String[] options = {"Actualizar Ahora", "Recordar Más Tarde", "Saltar Esta Versión"};
        
        int choice = JOptionPane.showOptionDialog(
            parentFrame,
            message,
            "Actualización Disponible - InstallerApp",
            JOptionPane.YES_NO_CANCEL_OPTION,
            JOptionPane.INFORMATION_MESSAGE,
            null,
            options,
            options[0]
        );
        
        switch (choice) {
            case 0: // Actualizar Ahora
                downloadAndInstallUpdate(updateInfo);
                break;
            case 1: // Recordar Más Tarde
                System.out.println("[UpdateChecker] Usuario eligió 'Recordar Más Tarde'");
                break;
            case 2: // Saltar Esta Versión
                System.out.println("[UpdateChecker] Usuario eligió 'Saltar Esta Versión'");
                // TODO: Implementar lista de versiones saltadas
                break;
            default: // Cerrar dialog
                System.out.println("[UpdateChecker] Dialog cerrado sin selección");
                break;
        }
    }
    
    /**
     * Descargar e instalar actualización
     */
    private void downloadAndInstallUpdate(UpdateInfo updateInfo) {
        CompletableFuture.runAsync(() -> {
            try {
                System.out.println("[UpdateChecker] Iniciando descarga de actualización...");
                
                // 1. Mostrar progress dialog
                SwingUtilities.invokeLater(() -> showProgressDialog("Descargando actualización..."));
                
                // 2. Descargar archivo
                Path downloadedFile = downloadUpdate(updateInfo);
                if (downloadedFile == null) {
                    SwingUtilities.invokeLater(() -> {
                        hideProgressDialog();
                        showErrorDialog("Error durante la descarga. Intente más tarde.");
                    });
                    return;
                }
                
                // 3. Validar archivo (básico)
                if (!validateDownload(downloadedFile)) {
                    SwingUtilities.invokeLater(() -> {
                        hideProgressDialog();
                        showErrorDialog("El archivo descargado está corrupto. Intente más tarde.");
                    });
                    return;
                }
                
                // 4. Preparar instalación
                SwingUtilities.invokeLater(() -> updateProgressDialog("Preparando instalación..."));
                
                boolean installationPrepared = prepareInstallation(downloadedFile, updateInfo);
                
                SwingUtilities.invokeLater(() -> {
                    hideProgressDialog();
                    
                    if (installationPrepared) {
                        showInstallationReadyDialog(updateInfo);
                    } else {
                        showErrorDialog("Error preparando la instalación. Intente más tarde.");
                    }
                });
                
            } catch (Exception e) {
                System.err.println("[UpdateChecker] Error durante actualización: " + e.getMessage());
                e.printStackTrace();
                
                SwingUtilities.invokeLater(() -> {
                    hideProgressDialog();
                    showErrorDialog("Error inesperado durante la actualización: " + e.getMessage());
                });
            }
        });
    }
    
    /**
     * Descargar el archivo de actualización
     */
    private Path downloadUpdate(UpdateInfo updateInfo) {
        try {
            URL downloadUrl = new URL(updateInfo.downloadUrl);
            HttpURLConnection connection = (HttpURLConnection) downloadUrl.openConnection();
            
            connection.setRequestProperty("User-Agent", USER_AGENT);
            connection.setConnectTimeout(CONNECTION_TIMEOUT_MS);
            connection.setReadTimeout(READ_TIMEOUT_MS);
            
            if (connection.getResponseCode() != 200) {
                System.err.println("[UpdateChecker] Error descargando: HTTP " + connection.getResponseCode());
                return null;
            }
            
            // Crear archivo de destino
            Path downloadPath = Paths.get(TEMP_UPDATE_DIR, updateInfo.fileName);
            
            // Descargar con InputStream
            try (InputStream inputStream = connection.getInputStream()) {
                Files.copy(inputStream, downloadPath, StandardCopyOption.REPLACE_EXISTING);
            }
            
            System.out.println("[UpdateChecker] Descarga completada: " + downloadPath);
            return downloadPath;
            
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error durante descarga: " + e.getMessage());
            return null;
        }
    }
    
    /**
     * Validar archivo descargado (verificación básica de tamaño)
     */
    private boolean validateDownload(Path filePath) {
        try {
            long fileSize = Files.size(filePath);
            System.out.println("[UpdateChecker] Validando archivo. Tamaño: " + fileSize + " bytes");
            
            // Verificación básica: archivo debe ser mayor a 1KB
            return fileSize > 1024;
            
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error validando archivo: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Preparar script de instalación
     */
    private boolean prepareInstallation(Path downloadedFile, UpdateInfo updateInfo) {
        try {
            // Crear script de instalación update.bat
            Path scriptPath = Paths.get(TEMP_UPDATE_DIR, "update.bat");
            
            String currentJarPath = getCurrentJarPath();
            String backupJarPath = currentJarPath + ".backup";
            String installDir = new File(currentJarPath).getParent();
            
            System.out.println("[UpdateChecker] Preparando instalación...");
            System.out.println("[UpdateChecker] JAR actual: " + currentJarPath);
            System.out.println("[UpdateChecker] JAR descargado: " + downloadedFile.toString());
            System.out.println("[UpdateChecker] Backup: " + backupJarPath);
            
            // Crear e inicializar el script
            StringBuilder script = new StringBuilder();
            script.append("@echo off\n");
            script.append("set \"INSTALL_DIR=").append(installDir).append("\"\n\n");

            script.append("echo Verificando permisos de administrador sin bucle ...\n");
            // Check if already running as administrator
            script.append("net session >nul 2>&1\n");
            script.append("if %errorlevel% == 0 (\n");
            script.append("    echo Ya se ejecuta como administrador.\n");
            script.append("    goto :continue\n");
            script.append(")\n");
            script.append("echo Solicitando permisos de administrador...\n");
            // Request admin privileges using PowerShell (corrected quote escaping)
            script.append("powershell -Command \"Start-Process -FilePath '%~f0' -Verb RunAs\"\n");
            script.append("exit /b\n\n");
            script.append(":continue\n");
            script.append("title InstallerApp - Actualizacion a ").append(updateInfo.version).append("\n");
            script.append("color 0A\n");
            script.append("echo ========================================\n");
            script.append("echo    InstallerApp - Sistema de Actualizacion de Calculator.java\n");
            script.append("echo ========================================\n");
            script.append("echo.\n");
            script.append("echo Instalando version ").append(updateInfo.version).append("...\n");
            script.append("echo.\n");
            script.append("\n");
            script.append("REM Esperar 10 segundos para que se cierre completamente la aplicación\n");
            script.append("echo Esperando que se cierre la aplicacion...\n");
            script.append("timeout /t 10 /nobreak\n");
            
            // Kill any remaining Java processes that might be using our JAR
            script.append("echo Asegurando que la aplicacion este cerrada...\n");
            script.append("taskkill /F /IM java.exe /FI \"WINDOWTITLE eq InstallerApp*\" >nul 2>&1\n");
            script.append("echo.\n");
            script.append("\n");
            script.append("REM Verificar que el archivo actual existe\n");
            script.append("if not exist \"").append(currentJarPath).append("\" (\n");
            script.append("    echo ERROR: No se encontro el archivo actual en:\n");
            script.append("    echo ").append(currentJarPath).append("\n");
            script.append("    echo.\n");
            script.append("    pause\n");
            script.append("    exit /b 1\n");
            script.append(")\n");
            script.append("\n");
            script.append("\n");
            script.append("REM Determinar la ruta del nuevo JAR\n");
            script.append("set \"NEW_JAR=%INSTALL_DIR%\\InstallerApp-").append(updateInfo.version).append(".jar\"\n");
            script.append("\n");
            script.append("REM Crear backup de la versión actual\n");
            script.append("echo Creando respaldo de version actual...\n");
            script.append("copy \"").append(currentJarPath).append("\" \"").append(backupJarPath).append("\"\n");
            script.append("if errorlevel 1 (\n");
            script.append("    echo ERROR: No se pudo crear backup\n");
            script.append("    echo.\n");
            script.append("    pause\n");
            script.append("    exit /b 1\n");
            script.append(")\n");
            script.append("echo Backup creado exitosamente.\n");
            script.append("echo.\n");
            script.append("\n");
            script.append("\n");
            script.append("REM Renombrar JAR actual si existe\n");
            script.append("if exist \"").append(currentJarPath).append("\" (\n");
            script.append("    echo Preparando para nueva version...\n");
            script.append("    ren \"").append(currentJarPath).append("\" \"InstallerApp-").append(updateInfo.version).append(".jar\" >nul 2>&1\n");
            script.append("    if errorlevel 1 (\n");
            script.append("        echo ERROR: No se pudo renombrar el archivo actual\n");
            script.append("        echo.\n");
            script.append("        pause\n");
            script.append("        exit /b 1\n");
            script.append("    )\n");
            script.append(")\n");
            script.append("REM Verificar que el archivo descargado existe\n");
            script.append("if not exist \"").append(downloadedFile.toString()).append("\" (\n");
            script.append("    echo ERROR: No se encontro el archivo descargado en:\n");
            script.append("    echo ").append(downloadedFile.toString()).append("\n");
            script.append("    echo.\n");
            script.append("    pause\n");
            script.append("    exit /b 1\n");
            script.append(")\n");
            script.append("\n");
            script.append("REM Verificar si el archivo destino existe y eliminarlo\n");
            script.append("echo Preparando instalacion de nueva version...\n");
            script.append("if exist \"").append(currentJarPath).append("\" (\n");
            script.append("    del /F /Q \"").append(currentJarPath).append("\"\n");
            script.append("    if errorlevel 1 (\n");
            script.append("        echo ERROR: No se pudo eliminar la version anterior\n");
            script.append("        echo Es posible que necesite permisos de administrador\n");
            script.append("        echo.\n");
            script.append("        pause\n");
            script.append("        exit /b 1\n");
            script.append("    )\n");
            script.append(")\n\n");
            
            script.append("REM Instalar nueva versión\n");
            script.append("echo Instalando nueva version...\n");
            script.append("copy /B /Y \"").append(downloadedFile.toString()).append("\" \"").append(currentJarPath).append("\"\n");
            script.append("if errorlevel 1 (\n");
            script.append("    echo ERROR: No se pudo instalar nueva version\n");
            script.append("    echo Restaurando backup...\n");
            script.append("    copy /B /Y \"").append(backupJarPath).append("\" \"").append(currentJarPath).append("\"\n");
            script.append("    echo.\n");
            script.append("    pause\n");
            script.append("    exit /b 1\n");
            script.append(")\n\n");
            
            script.append("REM Verificar integridad del archivo copiado\n");
            script.append("echo Verificando instalacion...\n");
            script.append("fc /b \"").append(downloadedFile.toString()).append("\" \"").append(currentJarPath).append("\" >nul\n");
            script.append("if errorlevel 1 (\n");
            script.append("    echo ERROR: La verificacion de archivos fallo\n");
            script.append("    echo Restaurando backup...\n");
            script.append("    copy /B /Y \"").append(backupJarPath).append("\" \"").append(currentJarPath).append("\"\n");
            script.append("    echo.\n");
            script.append("    pause\n");
            script.append("    exit /b 1\n");
            script.append(")\n");
            script.append("echo Nueva version instalada exitosamente!\n");
            script.append("echo.\n");
            script.append("\n");
            script.append("\n");
            script.append("REM Actualizar run-app.bat\n");
            script.append("echo @echo off > \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo REM Script para ejecutar la aplicacion Java >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo. >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo REM Cambiar al directorio de la aplicacion >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo cd /d \"%%~dp0\" >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo. >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo REM Verificar que Java este instalado >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo java -version ^>nul 2^>^&1 >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo if %%errorlevel%% neq 0 ( >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo     echo Error: Java no esta instalado en este sistema. >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo     echo Por favor, instala Java desde https://adoptium.net/ >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo     echo. >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo     pause >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo     call exit /b 1 >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo ) >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo. >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo REM Ejecutar la aplicacion >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo echo Iniciando InstallerApp ").append(updateInfo.version).append("... >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo java -jar \"InstallerApp-").append(updateInfo.version).append(".jar\" >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo. >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo echo Aplicacion terminada. Presiona cualquier tecla para cerrar... >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("echo pause ^>nul >> \"%INSTALL_DIR%\\run-app.bat\"\n");
            script.append("REM Limpiar backup\n");
            script.append("del \"").append(backupJarPath).append("\" >nul 2>&1\n");
            script.append("\n");
            script.append("echo ========================================\n");
            script.append("echo Actualizacion completada exitosamente!\n");
            script.append("echo Nueva version: ").append(updateInfo.version).append("\n");
            script.append("echo ========================================\n");
            script.append("echo.\n");
            script.append("echo Reiniciando aplicacion en 3 segundos...\n");
            script.append("timeout /t 3 /nobreak\n");
            script.append("\n");
            script.append("REM Reiniciar aplicación\n");
            script.append("start \"InstallerApp\" java -jar \"").append(currentJarPath).append("\"\n");
            script.append("\n");
            script.append("REM Limpiar archivos temporales\n");
            script.append("echo Limpiando archivos temporales...\n");
            script.append("del \"").append(downloadedFile.toString()).append("\" >nul 2>&1\n");
            script.append("timeout /t 2 /nobreak >nul\n");
            script.append("del \"").append(scriptPath.toString()).append("\" >nul 2>&1\n");
            script.append("\n");
            script.append("echo Proceso completado. Cerrando...\n");
            script.append("exit /b\n");
            
            Files.write(scriptPath, script.toString().getBytes());
            
            System.out.println("[UpdateChecker] Script de instalación creado: " + scriptPath);
            System.out.println("[UpdateChecker] Script listo para ejecutar.");
            return true;
            
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error preparando instalación: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }
    
    /**
     * Obtener path del JAR actual
     */
    private String getCurrentJarPath() {
        try {
            //buscar en el directorio actual primero
            File currentDir = new File(System.getProperty("user.dir"));
            File[] jarFiles = currentDir.listFiles((dir, name) -> name.startsWith("InstallerApp") && name.endsWith(".jar"));

            if (jarFiles != null && jarFiles.length > 0) {
                String detectedPath = jarFiles[0].getAbsolutePath();
                System.out.println("[UpdateChecker] JAR encontrado en directorio actual: " + detectedPath);
                return detectedPath;
            }

            // Buscar en el directorio de instalación
            String installDir = "C:\\Program Files\\InstallerApp\\TGCS";
            File[] installJarFiles = new File(installDir).listFiles((dir, name) -> name.startsWith("InstallerApp") && name.endsWith(".jar"));

            if (installJarFiles != null && installJarFiles.length > 0) {
                String detectedPath = installJarFiles[0].getAbsolutePath();
                System.out.println("[UpdateChecker] JAR encontrado en directorio de instalación: " + detectedPath);
                return detectedPath;
            }

            //Si no se encuentra, usar el path estándar con la versión actual
            String standardPath = "C:\\Program Files\\InstallerApp\\TGCS\\InstallerApp-" + CURRENT_VERSION + ".jar";
            System.out.println("[UpdateChecker] Usando path estándar: " + standardPath);
            return standardPath;

        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error obteniendo JAR path: " + e.getMessage());
            String fallbackPath = "C:\\Program Files\\InstallerApp\\TGCS\\InstallerApp-" + CURRENT_VERSION + ".jar";
            System.out.println("[UpdateChecker] Usando path de respaldo: " + fallbackPath);
            return fallbackPath;
        }
    }

    /**
     * Mostrar dialog de instalación lista
     */
    private void showInstallationReadyDialog(UpdateInfo updateInfo) {
        String message = String.format(
            "Actualización descargada y lista para instalar.\n\n" +
            "Versión: %s\n\n" +
            "La aplicación se cerrará, se instalará la actualización\n" +
            "y se reiniciará automáticamente.\n\n" +
            "¿Proceder con la instalación?",
            updateInfo.version
        );
        
        String[] options = {"Instalar Ahora", "Instalar Al Cerrar", "Cancelar"};
        
        int choice = JOptionPane.showOptionDialog(
            parentFrame,
            message,
            "Instalación Lista - InstallerApp",
            JOptionPane.YES_NO_CANCEL_OPTION,
            JOptionPane.QUESTION_MESSAGE,
            null,
            options,
            options[0]
        );
        
        switch (choice) {
            case 0: // Instalar Ahora
                System.out.println("[UpdateChecker] Usuario seleccionó: Instalar Ahora");
                executeInstallation();
                break;
            case 1: // Instalar Al Cerrar
                System.out.println("[UpdateChecker] Usuario seleccionó: Instalar Al Cerrar");
                System.out.println("[UpdateChecker] Instalación programada para el cierre de la aplicación");
                // TODO: Programar instalación para shutdown hook
                break;
            case 2: // Cancelar
                System.out.println("[UpdateChecker] Usuario seleccionó: Cancelar");
                System.out.println("[UpdateChecker] Instalación cancelada por el usuario");
                // Limpiar archivos temporales
                cleanupTempFiles();
                break;
            default:
                System.out.println("[UpdateChecker] Dialog cerrado sin selección");
                cleanupTempFiles();
                break;
        }
    }
    
    /**
     * Ejecutar instalación inmediata
     */
    private void executeInstallation() {
        try {
            Path scriptPath = Paths.get(TEMP_UPDATE_DIR, "update.bat");
            
            if (!Files.exists(scriptPath)) {
                showErrorDialog("Script de instalación no encontrado.");
                return;
            }
            
            System.out.println("[UpdateChecker] Ejecutando instalación...");
            System.out.println("[UpdateChecker] Script ubicado en: " + scriptPath.toString());
            
            // Ejecutar script de instalación con ventana visible
            ProcessBuilder pb = new ProcessBuilder("cmd", "/c", "start", "cmd", "/k", scriptPath.toString());
            pb.directory(new File(TEMP_UPDATE_DIR));
            
            System.out.println("[UpdateChecker] Comando a ejecutar: " + String.join(" ", pb.command()));
            
            Process process = pb.start();
            
            System.out.println("[UpdateChecker] Proceso de instalación iniciado.");
            System.out.println("[UpdateChecker] La aplicación se cerrará en 2 segundos...");
            
            // Esperar un poco antes de cerrar para dar tiempo al script
            Thread.sleep(2000);
            
            // Cerrar aplicación
            System.out.println("[UpdateChecker] Cerrando aplicación para instalación...");
            System.exit(0);
            
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error ejecutando instalación: " + e.getMessage());
            e.printStackTrace();
            showErrorDialog("Error iniciando instalación: " + e.getMessage());
        }
    }
    
    /**
     * Limpiar archivos temporales de actualización
     */
    private void cleanupTempFiles() {
        try {
            Path tempDir = Paths.get(TEMP_UPDATE_DIR);
            if (Files.exists(tempDir)) {
                Files.list(tempDir).forEach(file -> {
                    try {
                        Files.delete(file);
                        System.out.println("[UpdateChecker] Archivo temporal eliminado: " + file);
                    } catch (IOException e) {
                        System.err.println("[UpdateChecker] No se pudo eliminar: " + file + " - " + e.getMessage());
                    }
                });
            }
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error limpiando archivos temporales: " + e.getMessage());
        }
    }
    
    // === MÉTODOS DE UTILIDAD ===
    
    /**
     * Crear directorio temporal para updates
     */
    private void createTempDirectory() {
        try {
            Path tempDir = Paths.get(TEMP_UPDATE_DIR);
            if (!Files.exists(tempDir)) {
                Files.createDirectories(tempDir);
                System.out.println("[UpdateChecker] Directorio temporal creado: " + tempDir);
            }
        } catch (Exception e) {
            System.err.println("[UpdateChecker] Error creando directorio temporal: " + e.getMessage());
        }
    }
    
    /**
     * Leer InputStream completo como String
     */
    private String readInputStream(InputStream inputStream) throws IOException {
        StringBuilder result = new StringBuilder();
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))) {
            String line;
            while ((line = reader.readLine()) != null) {
                result.append(line).append("\n");
            }
        }
        return result.toString();
    }
    
    // === MÉTODOS DE UI ===
    
    private JDialog progressDialog;
    private JLabel progressLabel;
    
    private void showProgressDialog(String message) {
        if (progressDialog != null) {
            progressDialog.dispose();
        }
        
        progressDialog = new JDialog(parentFrame, "Actualizando InstallerApp", true);
        progressDialog.setSize(400, 120);
        progressDialog.setLocationRelativeTo(parentFrame);
        progressDialog.setDefaultCloseOperation(JDialog.DO_NOTHING_ON_CLOSE);
        
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        
        progressLabel = new JLabel(message, JLabel.CENTER);
        panel.add(progressLabel, BorderLayout.CENTER);
        
        JProgressBar progressBar = new JProgressBar();
        progressBar.setIndeterminate(true);
        panel.add(progressBar, BorderLayout.SOUTH);
        
        progressDialog.add(panel);
        progressDialog.setVisible(true);
    }
    
    private void updateProgressDialog(String message) {
        if (progressLabel != null) {
            progressLabel.setText(message);
        }
    }
    
    private void hideProgressDialog() {
        if (progressDialog != null) {
            progressDialog.dispose();
            progressDialog = null;
        }
    }
    
    private void showErrorDialog(String message) {
        JOptionPane.showMessageDialog(
            parentFrame,
            message,
            "Error - InstallerApp Updater",
            JOptionPane.ERROR_MESSAGE
        );
    }
    
    /**
     * Cerrar el sistema de updates
     */
    public void shutdown() {
        if (scheduler != null && !scheduler.isShutdown()) {
            scheduler.shutdown();
            System.out.println("[UpdateChecker] Sistema de actualizaciones cerrado.");
        }
    }
    
    /**
     * Habilitar/deshabilitar verificaciones automáticas
     */
    public void setUpdateCheckEnabled(boolean enabled) {
        this.updateCheckEnabled = enabled;
        System.out.println("[UpdateChecker] Verificaciones automáticas: " + (enabled ? "habilitadas" : "deshabilitadas"));
    }
    
    /**
     * Clase interna para información de actualización
     */
    private static class UpdateInfo {
        String version;
        String downloadUrl;
        String fileName;
        String releaseNotes;
        
        @Override
        public String toString() {
            return String.format("UpdateInfo{version='%s', downloadUrl='%s', fileName='%s'}", 
                version, downloadUrl, fileName);
        }
    }
}
